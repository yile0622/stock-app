<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIU & FOCUS ÈªûË≤®Á≥ªÁµ±</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .ios-shadow { box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .tab-active { border-bottom: 3px solid #78350f; color: #78350f; }
        .loading-overlay { background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); }
        [v-cloak] { display: none; }
        /* Â∫óÈã™Â∞àÂ±¨Ëâ≤ */
        .shop-miu { color: #84522a; border-color: #84522a; }
        .shop-miu-bg { background-color: #fdf5ef; color: #84522a; }
        .shop-focus { color: #2563eb; border-color: #2563eb; }
        .shop-focus-bg { background-color: #eff6ff; color: #2563eb; }
        .btn-miu-active { background-color: #84522a !important; color: white !important; }
        .btn-focus-active { background-color: #2563eb !important; color: white !important; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-10">
    <div id="app" v-cloak class="max-w-2xl mx-auto">
        
        <div class="fixed bottom-4 left-4 z-50 flex gap-2">
            <div v-if="saving" class="bg-black text-white px-3 py-1 rounded-full text-[10px] shadow-lg animate-pulse">‚òÅÔ∏è ÂêåÊ≠•‰∏≠...</div>
            <button @click="fetchData" class="bg-white text-slate-600 px-3 py-1 rounded-full text-[10px] shadow border font-bold">üîÑ Âà∑Êñ∞</button>
        </div>

        <div v-if="loading" class="fixed inset-0 loading-overlay z-[100] flex flex-col items-center justify-center">
            <div class="w-8 h-8 border-4 border-amber-800 border-t-transparent rounded-full animate-spin mb-2"></div>
            <p class="text-amber-900 text-sm font-bold tracking-widest">Ë≥áÊñôÂÇ≥Ëº∏‰∏≠...</p>
        </div>

        <div class="sticky top-0 bg-white/90 backdrop-blur-md z-10 p-4 border-b">
            <h1 class="text-xl font-bold text-gray-800 mb-2 text-center">üì¶ MIU & FOCUS ÈªûË≤®Á≥ªÁµ±</h1>
            <input v-model="searchQuery" type="text" placeholder="üîç ÊêúÂ∞ãÊ¨æËôü„ÄÅÂêçÁ®±„ÄÅÂÆ¢‰∫∫..." 
                   class="w-full p-3 bg-gray-100 border-none rounded-xl focus:ring-2 focus:ring-amber-700 outline-none">
        </div>

        <div class="flex bg-white border-b text-sm font-medium text-gray-500">
            <button @click="view = 'items'" :class="{'tab-active': view === 'items'}" class="py-3 w-1/2 text-center">Ê¨æÂºèÁÆ°ÁêÜ</button>
            <button @click="view = 'customers'" :class="{'tab-active': view === 'customers'}" class="py-3 w-1/2 text-center">ÂÆ¢Êà∂Á∏ΩË¶Ω</button>
        </div>

        <div v-if="view === 'items'" class="p-4">
            <div class="bg-white p-5 rounded-2xl ios-shadow mb-6 border border-amber-50">
                <h3 class="text-[10px] font-black text-amber-700 mb-3 tracking-widest uppercase">{{ editingItem ? 'Á∑®ËºØÊ¨æÂºè EDIT' : 'Êñ∞Â¢ûÂïÜÂìÅ ADD' }}</h3>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <input v-model="newItem.code" placeholder="Ê¨æËôü" class="border p-2 rounded-lg text-sm bg-gray-50 uppercase outline-none">
                    <input v-model="newItem.name" placeholder="ÂêçÁ®±" class="border p-2 rounded-lg text-sm bg-gray-50 outline-none">
                </div>
                <input v-model="newItem.colors" placeholder="È°èËâ≤ (Áî®ÈÄóËôüÈöîÈñã)" class="w-full border p-2 rounded-lg mb-3 text-sm bg-gray-50 outline-none">
                <div class="flex gap-2">
                    <button @click="addItem" class="flex-1 bg-amber-800 text-white py-3 rounded-xl font-bold shadow-lg shadow-amber-100">
                        {{ editingItem ? 'ÂÑ≤Â≠ò‰øÆÊîπ' : 'Âª∫Á´ãÂïÜÂìÅ' }}
                    </button>
                    <button v-if="editingItem" @click="cancelEditItem" class="px-4 bg-gray-200 text-gray-600 rounded-xl font-bold text-sm">ÂèñÊ∂à</button>
                </div>
            </div>

            <div class="space-y-3">
                <div v-for="item in filteredItems" :key="item.id" 
                     class="bg-white p-4 rounded-2xl ios-shadow flex justify-between items-center">
                    <div @click="openDetail(item)" class="flex-1 cursor-pointer">
                        <span class="text-[10px] font-bold bg-amber-100 text-amber-800 px-2 py-0.5 rounded mr-2 uppercase">{{ item.code }}</span>
                        <span class="font-bold text-gray-800">{{ item.name }}</span>
                    </div>
                    <div class="flex gap-3">
                        <button @click="startEditItem(item)" class="text-amber-700 text-xs">Á∑®ËºØ</button>
                        <button @click="deleteItem(item)" class="text-red-300 text-xs hover:text-red-500">Âà™Èô§</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="view === 'detail'" class="p-4">
            <button @click="view = 'items'" class="mb-4 text-amber-800 font-bold flex items-center">‚Äπ ËøîÂõûÊ∏ÖÂñÆ</button>
            
            <div class="bg-amber-800 p-4 rounded-2xl shadow-lg mb-4 text-white">
                <h3 class="text-xs font-bold mb-2 opacity-80 uppercase tracking-widest">üìä Áï∂ÂâçË®ÇË≥ºÁ∏ΩË®à</h3>
                <div class="flex flex-wrap gap-2">
                    <div v-for="(qty, color) in currentItemTotal" :key="color" class="bg-white/20 px-3 py-1 rounded-lg">
                        <span class="text-[10px] font-bold uppercase mr-1">{{ color }}</span>
                        <span class="text-lg font-black">{{ qty }}</span>
                    </div>
                    <div v-if="Object.keys(currentItemTotal).length === 0" class="text-sm opacity-60 italic">Â∞öÊú™ÊúâÁôªË®òÁ¥ÄÈåÑ</div>
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl ios-shadow">
                <h2 class="text-xl font-bold mb-4 text-slate-800">{{ selectedItem.code }} {{ selectedItem.name }}</h2>
                
                <div class="bg-slate-50 p-4 rounded-xl mb-6 border border-slate-200">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">{{ editingRecordIndex !== null ? '‚úèÔ∏è Á∑®ËºØÁ¥ÄÈåÑ' : 'üÜï Êñ∞Â¢ûÁôªË®ò' }}</h3>
                        <div class="flex bg-gray-200 p-1 rounded-lg shadow-inner">
                            <button @click="newRecord.shop = 'MIU'" :class="newRecord.shop === 'MIU' ? 'btn-miu-active shadow-sm' : 'text-gray-400'" class="px-4 py-1.5 rounded-md text-[10px] font-black transition-all">MIU</button>
                            <button @click="newRecord.shop = 'FOCUS'" :class="newRecord.shop === 'FOCUS' ? 'btn-focus-active shadow-sm' : 'text-gray-400'" class="px-4 py-1.5 rounded-md text-[10px] font-black transition-all">FOCUS</button>
                        </div>
                    </div>
                    
                    <input v-model="newRecord.name" placeholder="üë§ ÂÆ¢‰∫∫ÂßìÂêç" class="w-full border p-3 rounded-xl mb-3 text-sm outline-none focus:ring-2 focus:ring-amber-600">
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <div v-for="color in selectedItem.colors" :key="color" class="flex items-center bg-white p-2 rounded-xl border">
                            <span class="text-[10px] w-12 truncate text-gray-400 font-bold uppercase">{{ color }}</span>
                            <input type="number" v-model.number="newRecord.qtys[color]" class="w-full text-right outline-none font-bold text-amber-700" placeholder="0">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button @click="addRecord" :class="newRecord.shop === 'MIU' ? 'bg-[#84522a]' : 'bg-[#2563eb]'" class="flex-1 text-white py-3 rounded-xl font-bold transition-colors">
                            {{ editingRecordIndex !== null ? 'Êõ¥Êñ∞Á¥ÄÈåÑ' : 'Á¢∫Ë™çÁôªË®ò' }}
                        </button>
                        <button v-if="editingRecordIndex !== null" @click="cancelEditRecord" class="px-4 bg-gray-200 text-gray-600 rounded-xl font-bold text-sm">ÂèñÊ∂à</button>
                    </div>
                </div>

                <div class="space-y-4">
                    <div v-for="(r, idx) in selectedItem.records" :key="idx" class="bg-gray-50 p-4 rounded-xl border relative">
                        <div class="flex justify-between items-start mb-1">
                            <div>
                                <span :class="r.shop === 'MIU' ? 'shop-miu-bg' : 'shop-focus-bg'" class="text-[9px] font-black px-2 py-0.5 rounded mr-1 italic">{{ r.shop }}</span>
                                <span class="font-black text-gray-700 mr-2">{{ r.name }}</span>
                                <span class="text-[9px] text-gray-400 block mt-1 tracking-tighter">{{ r.time }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <select v-model="r.status" @change="saveData" :class="statusColor(r.status)" class="text-[10px] rounded-full px-2 py-1 font-bold shadow-sm">
                                    <option>Êú™Âà∞Ë≤®</option><option>Âà∞Ë≤®</option><option>Áº∫Èáè</option>
                                </select>
                                <button @click="startEditRecord(idx)" class="text-slate-400 text-xs">‚úèÔ∏è</button>
                                <button @click="deleteRecord(idx)" class="text-red-300 text-lg">√ó</button>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 text-xs mt-2">
                            <span v-for="(q, c) in r.qtys" v-show="q > 0" class="bg-white px-2 py-0.5 rounded border text-gray-500 font-bold">
                                {{ c }}: {{ q }}
                            </span>
                        </div>
                        <div v-if="r.status === 'Áº∫Èáè'" class="mt-2 p-2 bg-red-50 rounded-lg border border-red-100">
                            <div class="grid grid-cols-2 gap-2">
                                <div v-for="(q, c) in r.qtys" v-show="q > 0" :key="c" class="flex justify-between items-center bg-white px-2 py-1 rounded border">
                                    <span class="text-[9px] text-gray-400">{{ c }} ÂØ¶Âà∞:</span>
                                    <input type="number" v-model.number="r.actualQtys[c]" @change="saveData" class="w-8 text-right font-bold text-red-600 outline-none">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="view === 'customers'" class="p-4">
            <div v-for="(summary, name) in groupedCustomerSummary" :key="name" class="bg-white p-5 rounded-2xl ios-shadow mb-4 border-l-4" :class="summary.hasMissing ? 'border-red-400' : 'border-emerald-400'">
                <h3 class="font-black text-lg mb-3 border-b pb-1 flex justify-between items-center">
                    <span>üë§ {{ name }}</span>
                    <span v-if="summary.hasMissing" class="text-[9px] bg-red-500 text-white px-2 py-0.5 rounded-full uppercase">Ê¨†Ë≤®‰∏≠</span>
                </h3>
                <div v-for="item in summary.items" :key="item.code" class="mb-4 last:mb-0">
                    <p class="text-[10px] font-black text-slate-400 mb-2 uppercase">{{ item.code }} - {{ item.name }}</p>
                    <div class="grid grid-cols-1 gap-2">
                        <div v-for="(stats, color) in item.colors" :key="color" class="flex flex-col bg-slate-50 p-2 rounded-lg border border-slate-100">
                            <div class="flex justify-between items-center text-xs">
                                <span class="font-bold text-slate-600 uppercase">{{ color }}</span>
                                <div class="flex gap-2 items-center">
                                    <span class="text-slate-400 scale-90">È†êË®Ç: {{ stats.total }}</span>
                                    <span v-if="stats.missing > 0" class="text-red-600 font-black bg-white px-2 py-0.5 rounded border border-red-100">Ê¨†: {{ stats.missing }}</span>
                                    <span v-else class="text-emerald-600 font-black">Â∑≤ÈΩä</span>
                                </div>
                            </div>
                            <div class="flex gap-3 mt-1.5 pt-1.5 border-t border-dashed border-slate-200">
                                <span v-if="stats.shops.MIU" class="text-[10px] font-bold text-[#84522a]">MIU: {{ stats.shops.MIU }} ‰ª∂</span>
                                <span v-if="stats.shops.FOCUS" class="text-[10px] font-bold text-[#2563eb]">FOCUS: {{ stats.shops.FOCUS }} ‰ª∂</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CLOUD_API = "https://script.google.com/macros/s/AKfycbz85Vud5u0MqEhG6GaSqWnNjqwa7wx2NFV5aZLmx07slZPseuqQHbrdzAS7gAW-jifM/exec";
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    view: 'items',
                    searchQuery: '',
                    newItem: { id: null, name: '', code: '', colors: '' },
                    editingItem: null,
                    selectedItem: null,
                    newRecord: { name: '', qtys: {}, shop: 'MIU' },
                    editingRecordIndex: null,
                    items: [],
                    loading: true,
                    saving: false
                }
            },
            mounted() { this.fetchData(); },
            computed: {
                filteredItems() {
                    const q = this.searchQuery.toLowerCase();
                    return this.items.filter(i => i.name.toLowerCase().includes(q) || i.code.toLowerCase().includes(q));
                },
                currentItemTotal() {
                    if (!this.selectedItem) return {};
                    const totals = {};
                    this.selectedItem.records.forEach(r => {
                        Object.entries(r.qtys).forEach(([color, qty]) => {
                            if (qty > 0) totals[color] = (totals[color] || 0) + qty;
                        });
                    });
                    return totals;
                },
                groupedCustomerSummary() {
                    const summary = {};
                    this.items.forEach(item => {
                        item.records.forEach(r => {
                            if (!summary[r.name]) summary[r.name] = { items: {}, hasMissing: false };
                            if (!summary[r.name].items[item.id]) {
                                summary[r.name].items[item.id] = { code: item.code, name: item.name, colors: {} };
                            }
                            Object.entries(r.qtys).forEach(([color, qty]) => {
                                if (qty > 0) {
                                    if (!summary[r.name].items[item.id].colors[color]) {
                                        summary[r.name].items[item.id].colors[color] = { total: 0, actual: 0, missing: 0, shops: {} };
                                    }
                                    const stats = summary[r.name].items[item.id].colors[color];
                                    stats.total += qty;
                                    stats.shops[r.shop] = (stats.shops[r.shop] || 0) + qty;
                                    
                                    if (r.status === 'Âà∞Ë≤®') stats.actual += qty;
                                    else if (r.status === 'Áº∫Èáè') stats.actual += (r.actualQtys[color] || 0);
                                    
                                    stats.missing = stats.total - stats.actual;
                                    if (stats.missing > 0) summary[r.name].hasMissing = true;
                                }
                            });
                        });
                    });
                    const q = this.searchQuery.toLowerCase();
                    if (!q) return summary;
                    const res = {};
                    Object.keys(summary).forEach(n => { if (n.toLowerCase().includes(q)) res[n] = summary[n]; });
                    return res;
                }
            },
            methods: {
                async fetchData() {
                    this.loading = true;
                    try {
                        const res = await fetch(CLOUD_API);
                        this.items = await res.json() || [];
                    } catch (e) { console.error(e); } finally { this.loading = false; }
                },
                async saveData() {
                    this.saving = true;
                    try {
                        await fetch(CLOUD_API, { method: "POST", body: JSON.stringify(this.items) });
                    } catch (e) { alert("ÂêåÊ≠•Â§±Êïó"); } finally { this.saving = false; }
                },
                addItem() {
                    if (!this.newItem.name || !this.newItem.code) return;
                    const colorList = this.newItem.colors.split(/[,Ôºå]/).map(s => s.trim()).filter(s => s);
                    if (this.editingItem) {
                        Object.assign(this.editingItem, { name: this.newItem.name, code: this.newItem.code.toUpperCase(), colors: colorList });
                        this.editingItem = null;
                    } else {
                        this.items.unshift({ id: Date.now(), code: this.newItem.code.toUpperCase(), name: this.newItem.name, colors: colorList, records: [] });
                    }
                    this.newItem = { id: null, name: '', code: '', colors: '' };
                    this.saveData();
                },
                startEditItem(item) {
                    this.editingItem = item;
                    this.newItem = { ...item, colors: item.colors.join(',') };
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                },
                cancelEditItem() {
                    this.editingItem = null;
                    this.newItem = { id: null, name: '', code: '', colors: '' };
                },
                deleteItem(item) {
                    if (confirm("Á¢∫ÂÆöÂà™Èô§Ê≠§Ê¨æÂºèÔºü")) {
                        this.items = this.items.filter(i => i.id !== item.id);
                        this.saveData();
                    }
                },
                openDetail(item) {
                    this.selectedItem = item;
                    this.cancelEditRecord();
                    this.view = 'detail';
                },
                addRecord() {
                    if (!this.newRecord.name) return;
                    if (this.editingRecordIndex !== null) {
                        const target = this.selectedItem.records[this.editingRecordIndex];
                        Object.assign(target, { name: this.newRecord.name, qtys: { ...this.newRecord.qtys }, shop: this.newRecord.shop });
                        this.editingRecordIndex = null;
                    } else {
                        this.selectedItem.records.unshift({
                            ...this.newRecord,
                            actualQtys: { ...this.newRecord.qtys },
                            status: 'Êú™Âà∞Ë≤®',
                            time: new Date().toLocaleString('zh-TW', { hour12: false, month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
                        });
                    }
                    const shopBackup = this.newRecord.shop;
                    this.newRecord = { name: '', qtys: {}, shop: shopBackup };
                    this.selectedItem.colors.forEach(c => this.newRecord.qtys[c] = null);
                    this.saveData();
                },
                startEditRecord(idx) {
                    this.editingRecordIndex = idx;
                    const r = this.selectedItem.records[idx];
                    this.newRecord = { name: r.name, qtys: { ...r.qtys }, shop: r.shop };
                    window.scrollTo({ top: 100, behavior: 'smooth' });
                },
                cancelEditRecord() {
                    this.editingRecordIndex = null;
                    const shopBackup = this.newRecord?.shop || 'MIU';
                    this.newRecord = { name: '', qtys: {}, shop: shopBackup };
                    if (this.selectedItem) this.selectedItem.colors.forEach(c => this.newRecord.qtys[c] = null);
                },
                deleteRecord(index) {
                    if (confirm("Á¢∫ÂÆöÂà™Èô§Ôºü")) {
                        this.selectedItem.records.splice(index, 1);
                        this.saveData();
                    }
                },
                statusColor(status) {
                    if (status === 'Âà∞Ë≤®') return 'text-emerald-700 bg-emerald-100';
                    if (status === 'Áº∫Èáè') return 'text-rose-700 bg-rose-100';
                    return 'text-orange-700 bg-orange-100';
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
